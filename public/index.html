<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>tailwind.config={theme:{extend:{colors:{primary:'#1e40af',secondary:'#3b82f6'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="px-6 py-4">
    <div class="flex items-center justify-between">
    <div class="flex items-center space-x-8">
    <div class="text-2xl font-['Pacifico'] text-primary">wavedo</div>
    <div class="hidden md:flex space-x-6">
    </div>
    </div>
    <div class="flex items-center space-x-4">
    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
    <span class="text-white text-sm font-medium">U</span>
    </div>
    </div>
    </div>
    </div>
    </nav>
    <main class="px-6 py-8 max-w-7xl mx-auto">
    <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Portfolio Dashboard</h1>
    <p class="text-gray-600">Monitor and manage your investment portfolio</p>
    </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-600">Total Portfolio Value</h3>
                    <div class="w-8 h-8 flex items-center justify-center bg-green-100 rounded-lg">
                        <i class="ri-line-chart-line text-green-600"></i>
                    </div>
                </div>
                <div id="totalValue" class="text-2xl font-bold text-gray-900 mb-1">$0.00</div>
                <div class="flex items-center text-sm mb-2">
                    <span class="text-green-600 font-medium">+2.34%</span>
                    <span class="text-gray-500 ml-1">from last month</span>
                </div>
                <div class="space-y-1.5">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Stocks</span>
                        <span id="stocksValue" class="text-gray-900">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">ETFs</span>
                        <span id="etfsValue" class="text-gray-900">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Bonds</span>
                        <span id="bondsValue" class="text-gray-900">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Cash</span>
                        <span id="cashValue" class="text-gray-900">$0.00</span>
                    </div>
                </div>
            </div>
    <div class="bg-white rounded-xl p-6 border border-gray-200">
    <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-medium text-gray-600">Total Return</h3>
    <div class="w-8 h-8 flex items-center justify-center bg-blue-100 rounded-lg">
    <i class="ri-arrow-up-line text-blue-600"></i>
    </div>
    </div>
    <div class="text-2xl font-bold text-gray-900 mb-3">$127,843.20</div>
    <div class="space-y-2">
    <div class="flex justify-between items-center">
    <div class="flex items-center gap-2">
    <div class="w-2 h-2 rounded-full bg-[rgba(87,181,231,1)]"></div>
    <span class="text-sm text-gray-600">Stocks</span>
    </div>
    <div class="text-sm">
    <span class="font-medium text-gray-900">$58,234.50</span>
    <span class="text-green-600 ml-2">+24.5%</span>
    </div>
    </div>
    <div class="flex justify-between items-center">
    <div class="flex items-center gap-2">
    <div class="w-2 h-2 rounded-full bg-[rgba(141,211,199,1)]"></div>
    <span class="text-sm text-gray-600">ETFs</span>
    </div>
    <div class="text-sm">
    <span class="font-medium text-gray-900">$32,456.80</span>
    <span class="text-green-600 ml-2">+15.8%</span>
    </div>
    </div>
    <div class="flex justify-between items-center">
    <div class="flex items-center gap-2">
    <div class="w-2 h-2 rounded-full bg-[rgba(251,191,114,1)]"></div>
    <span class="text-sm text-gray-600">Bonds</span>
    </div>
    <div class="text-sm">
    <span class="font-medium text-gray-900">$28,890.45</span>
    <span class="text-green-600 ml-2">+12.3%</span>
    </div>
    </div>
    <div class="flex justify-between items-center">
    <div class="flex items-center gap-2">
    <div class="w-2 h-2 rounded-full bg-[rgba(252,141,98,1)]"></div>
    <span class="text-sm text-gray-600">Cash</span>
    </div>
    <div class="text-sm">
    <span class="font-medium text-gray-900">$8,261.45</span>
    <span class="text-green-600 ml-2">+3.2%</span>
    </div>
    </div>
    </div>
    </div>
    <div class="bg-white rounded-xl p-6 border border-gray-200">
    <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-medium text-gray-600">Day's Change</h3>
    <div class="w-8 h-8 flex items-center justify-center bg-orange-100 rounded-lg">
    <i class="ri-calendar-line text-orange-600"></i>
    </div>
    </div>
    <div class="text-2xl font-bold text-gray-900 mb-1">+$3,247.85</div>
    <div class="flex items-center text-sm">
    <span class="text-green-600 font-medium">+0.38%</span>
    <span class="text-gray-500 ml-1">today</span>
    </div>
    </div>
    <div class="bg-white rounded-xl p-6 border border-gray-200">
    <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-medium text-gray-600">Cash</h3>
    <div class="w-8 h-8 flex items-center justify-center bg-green-100 rounded-lg">
    <i class="ri-bond-line text-green-600"></i>
    </div>
    </div>
    <div class="text-2xl font-bold text-gray-900 mb-1" id="cashValue1">$54,892.35</div>
    <div class="flex items-center justify-between">
    <span class="text-gray-500 text-sm">Available for investment</span>
    <button id="manageCashBtn" class="text-primary hover:text-primary/80 text-sm font-medium">
    <i class="ri-add-circle-line mr-1"></i>Manage Cash
    </button>
    </div>
    </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="lg:col-span-2 bg-white rounded-xl p-6 border border-gray-200">
    <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-bold text-gray-900">Portfolio Performance</h2>
    <div class="flex space-x-2">
    <button class="px-3 py-1 text-sm font-medium text-primary bg-primary/10 rounded-button">1D</button>
    <button class="px-3 py-1 text-sm font-medium text-gray-600 hover:text-primary rounded-button">1W</button>
    <button class="px-3 py-1 text-sm font-medium text-gray-600 hover:text-primary rounded-button">1M</button>
    </div>
    </div>
    <div id="portfolioChart" style="height: 300px;"></div>
    </div>
    <div class="bg-white rounded-xl p-6 border border-gray-200">
    <h2 class="text-xl font-bold text-gray-900 mb-6">Asset Allocation</h2>
    <div id="allocationChart" style="height: 300px;"></div>
    </div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200">
    <div class="p-6 border-b border-gray-200">
    <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-gray-900">Portfolio Holdings</h2>
    <div class="flex items-center space-x-4">
    <div class="relative">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
    <i class="ri-search-line text-gray-400"></i>
    </div>
    <input type="text" placeholder="Search assets..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-button text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
    </div>
    <button id="addAssetBtn" class="bg-primary text-white px-4 py-2 rounded-button font-medium whitespace-nowrap !rounded-button">
    <i class="ri-add-line mr-2"></i>Add Asset
    </button>
    </div>
    </div>
    <div class="flex space-x-2">
    <button class="category-btn px-4 py-2 text-sm font-medium text-primary bg-primary/10 rounded-button whitespace-nowrap">
    All Assets
    </button>
    <button class="category-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary rounded-button whitespace-nowrap">
    Stocks
    </button>
    <button class="category-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary rounded-button whitespace-nowrap">
    ETFs
    </button>
    <button class="category-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary rounded-button whitespace-nowrap">
    Bonds
    </button>
    </div>
    </div>
    <div class="overflow-x-auto">
    <table class="w-full">
    <thead class="bg-gray-50">
    <tr>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AVG Purchase Price</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Price</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
    </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200" id="portfolio-body">
    </tbody>
    </table>
    </div>
    </div>
    <!-- <div class="mt-8 flex justify-center space-x-4">
    <button class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-button font-medium hover:bg-gray-50 !rounded-button whitespace-nowrap">
    <i class="ri-download-line mr-2"></i>Export Data
    </button>
    <button class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-button font-medium hover:bg-gray-50 !rounded-button whitespace-nowrap">
    <i class="ri-file-text-line mr-2"></i>Generate Report
    </button>
    <button class="bg-primary text-white px-6 py-3 rounded-button font-medium hover:bg-primary/90 !rounded-button whitespace-nowrap">
    <i class="ri-refresh-line mr-2"></i>Rebalance Portfolio
    </button>
    </div> -->
    </main>
    <div id="manageCashModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-900">Manage Cash</h3>
                    <button class="closeCashModal w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
                <form id="manageCashForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Type</label>
                        <div class="flex space-x-4 mb-4">
                            <button type="button" id="depositBtn" class="flex-1 py-2 px-4 rounded-button border text-sm font-medium bg-primary text-white">
                                Deposit
                            </button>
                            <button type="button" id="withdrawBtn" class="flex-1 py-2 px-4 rounded-button border text-sm font-medium text-gray-700">
                                Withdraw
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                            <input type="number" id="cashAmount" min="0" step="0.01" placeholder="Enter amount" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-button text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                        </div>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="button" class="closeCashModal flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-button font-medium hover:bg-gray-50 !rounded-button whitespace-nowrap">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-button font-medium hover:bg-primary/90 !rounded-button whitespace-nowrap">
                            Confirm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="addAssetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-900" id="openAddAsset">Add New Asset</h3>
                    <button id="closeModal" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asset Type</label>
                        <div class="relative">
                            <select id="asset-type" class="appearance-none w-full px-3 py-2 border border-gray-300 rounded-button text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                <option value="" disabled selected>Select asset type</option>
                                <option value="stock">Stock</option>
                                <option value="etf">ETF</option>
                                <option value="bond">Bond</option>
                            </select>
                            <i class="ri-arrow-down-s-line absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asset Symbol</label>
                        <input type="text" placeholder="e.g., AAPL" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                        <input type="number" placeholder="Enter quantity" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Price</label>
                        <input type="number" step="0.01" placeholder="Enter purchase price" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Date</label>
                        <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancelBtn" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-button font-medium hover:bg-gray-50 !rounded-button whitespace-nowrap">
                        Cancel
                        </button>
                        <button type="submit" class="flex-1 bg-primary text-white py-2 px-4 rounded-button font-medium hover:bg-primary/90 !rounded-button whitespace-nowrap">
                        Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Below are all scripts -->
    <script id="chartInit">
    document.addEventListener('DOMContentLoaded', function() {
    const portfolioChart = echarts.init(document.getElementById('portfolioChart'));
    const allocationChart = echarts.init(document.getElementById('allocationChart'));

    //Initial chart options
    let currentView = '1D';
    let currrentSymbol = 'AAPL';

    //Initialize chart with empty data

    const portfolioOption = {
    animation: false,
    grid: {
    left: 0,
    right: 0,
    top: 40,
    bottom: 0,
    data: ['Price'],
    textStyle: { color: '#1f2937' }
    },
    legend: {
    top: 0,
    data: ['Total Portfolio Value', 'Stocks', 'ETFs', 'Bonds', 'Cash'],
    textStyle: { color: '#1f2937' }
    },
    xAxis: {
      type: 'category',
      data: [],
      axisLine: { show: true },
      axisTick: { show: true },
      axisLabel: { show: true, color: '#6b7280' },
      splitLine: { show: true, lineStyle: { color: '#e5e7eb' } }
    },
    yAxis: {
      type: 'value',
      axisLine: { show: true },
      axisTick: { show: true },
      axisLabel: { show: true, color: '#6b7280' },
      splitLine: { show: true, lineStyle: { color: '#e5e7eb' } }
    },
    series: [
    {
    name: 'Total Portfolio Value',
    data: [],
    type: 'line',
    smooth: true,
    symbol: 'none',
    lineStyle: { color: '#1e40af', width: 3 },
    z: 5
    },
    {
    name: 'Stocks',
    data: [],
    type: 'line',
    smooth: true,
    symbol: 'none',
    lineStyle: { color: 'rgba(87, 181, 231, 1)', width: 2 }
    },
    {
    name: 'ETFs',
    data: [],
    type: 'line',
    smooth: true,
    symbol: 'none',
    lineStyle: { color: 'rgba(87, 181, 231, 1)', width: 2 }
    },
    {
    name: 'Bonds',
    data: [],
    type: 'line',
    smooth: true,
    symbol: 'none',
    lineStyle: { color: 'rgba(251, 191, 114, 1)', width: 2 }
    },
    {
    name: 'Cash',
    data: [],
    type: 'line',
    smooth: true,
    symbol: 'none',
    lineStyle: { color: 'rgba(252, 141, 98, 1)', width: 2 }
    }
    ],
    tooltip: {
    trigger: 'axis',
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    borderColor: '#e5e7eb',
    textStyle: { color: '#1f2937' }
    }
    };

    portfolioChart.setOption(portfolioOption);


    async function fetchChartData(range) {
      const res = await fetch(`/api/stock/intraday/${currrentSymbol}?range=${range}`);
      return await res.json(); // {xAxis: [...], series: [[...], [...], ...]}
      
    }

    async function updatePortfolioChart(range){
      try{
        const data = await fetchChartData(range);

        if (!data || !data.xAxis || !data.series) {
          console.error('Invalid data format:', data);
          return;
        }

        console.log('xAxis:', data.xAxis, 'series:', data.series);

        portfolioOption.xAxis.data = data.xAxis;

        if (data.series.length === 1) {
          portfolioOption.series[0].data = data.series[0];
        } else {
          portfolioOption.series.forEach((series, index) => {
            series.data = data.series[index] || [];
          });
        }
        portfolioChart.setOption(portfolioOption);
      }catch(e) {
        console.error('Error fetching chart data:', e);
      }
      
    }

    //Initial load
    updatePortfolioChart(currentView);

    //Update chart when time range buttons are clicked
    const timeButtons = document.querySelectorAll('.lg\\:col-span-2 button');
    timeButtons.forEach(btn => {
      btn.addEventListener('click', function() {
          const label = btn.textContent.trim();
          if (['1D', '1W', '1M'].includes(label)) {
            currentView = label;
            updatePortfolioChart(label);
          }
        });
      });
        // 动态获取资产分布数据并绘制饼图
        async function drawAllocationChart() {
            try {
                const res = await fetch('/api/allAsset');
                const { asset } = await res.json();

                const data = [
                    { value: asset.Stocks, name: 'Stocks', itemStyle: { color: 'rgba(87, 181, 231, 1)' } },
                    { value: asset.ETFs, name: 'ETFs', itemStyle: { color: 'rgba(141, 211, 199, 1)' } },
                    { value: asset.Bonds, name: 'Bonds', itemStyle: { color: 'rgba(251, 191, 114, 1)' } },
                    { value: asset.Cash, name: 'Cash', itemStyle: { color: 'rgba(252, 141, 98, 1)' } },
                ];

                const allocationChart = echarts.init(document.getElementById('allocationChart'));
                allocationChart.setOption({
                    animation: false,
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['50%', '50%'],
                        data,
                        label: {
                            show: true,
                            formatter: '{b}', // 显示 name
                            fontSize: 12,
                            color: '#1f2937',
                            overflow: 'truncate', // 截断不要换行
                            width: 80, // 给定宽度（可按需调整）
                        },
                        labelLine: {
                            show: true,
                            length: 15,
                            length2: 10,
                            lineStyle: {
                                color: '#999'
                            }
                        },
                        itemStyle: { borderRadius: 4 }
                    }],
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#e5e7eb',
                        textStyle: { color: '#1f2937' }
                    }
                });
            } catch (err) {
                console.error('Failed to draw allocation chart:', err);
            }
        }

        drawAllocationChart();

        window.addEventListener('resize', function() {
            portfolioChart.resize();
            const allocationChart = echarts.getInstanceByDom(document.getElementById('allocationChart'));
            if (allocationChart) allocationChart.resize();
        });
    });
    </script>
    <script id="manageCashControls">
        document.addEventListener('DOMContentLoaded', function() {
            const addAssetBtn = document.getElementById('addAssetBtn');
            const modal = document.getElementById('addAssetModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const manageCashBtn = document.getElementById('manageCashBtn');
            const cashModal = document.getElementById('manageCashModal');
            const closeCashBtns = document.querySelectorAll('.closeCashModal');
            const depositBtn = document.getElementById('depositBtn');
            const withdrawBtn = document.getElementById('withdrawBtn');
            const manageCashForm = document.getElementById('manageCashForm');
            const cashAmountInput = document.getElementById('cashAmount');
            let transactionType = 'deposit';
            let currentCash = 54892.35;
            const cashValueElement = document.getElementById('cashValue');
            manageCashBtn.addEventListener('click', function() {
                cashModal.classList.remove('hidden');
            });
            closeCashBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    cashModal.classList.add('hidden');
                    resetCashForm();
                });
            });
            cashModal.addEventListener('click', function(e) {
                if (e.target === cashModal) {
                    cashModal.classList.add('hidden');
                    resetCashForm();
                }
            });
            depositBtn.addEventListener('click', function() {
                transactionType = 'deposit';
                depositBtn.classList.add('bg-primary', 'text-white');
                depositBtn.classList.remove('text-gray-700');
                withdrawBtn.classList.remove('bg-primary', 'text-white');
                withdrawBtn.classList.add('text-gray-700');
            });
            withdrawBtn.addEventListener('click', function() {
                transactionType = 'withdraw';
                withdrawBtn.classList.add('bg-primary', 'text-white');
                withdrawBtn.classList.remove('text-gray-700');
                depositBtn.classList.remove('bg-primary', 'text-white');
                depositBtn.classList.add('text-gray-700');
            });
            manageCashForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const amount = parseFloat(cashAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    cashAmountInput.classList.add('border-red-500');
                    return;
                }
                if (transactionType === 'withdraw' && amount > currentCash) {
                    cashAmountInput.classList.add('border-red-500');
                    return;
                }
                currentCash = transactionType === 'deposit' ? currentCash + amount : currentCash - amount;
                cashValueElement.textContent = `$${currentCash.toFixed(2)}`;
                // updateCashInChart();

                // 模拟后端调用
                console.log("Transaction Type:", transactionType, "Amount:", amount);
                // await fetch("/api/manage-cash", {
                //     method: "POST",
                //     headers: { "Content-Type": "application/json" },
                //     body: JSON.stringify({ transactionType, amount })
                // });

                cashModal.classList.add('hidden');
                resetCashForm();
            });
            // 重置现金表单
            function resetCashForm() {
                cashAmountInput.value = '';
                cashAmountInput.classList.remove('border-red-500');
                transactionType = 'deposit';
                depositBtn.classList.add('bg-primary', 'text-white');
                depositBtn.classList.remove('text-gray-700');
                withdrawBtn.classList.remove('bg-primary', 'text-white');
                withdrawBtn.classList.add('text-gray-700');
            }
            // 更新现金在投资组合图表中的显示
            // function updateCashInChart() {
            //     const portfolioChart = echarts.getInstanceByDom(document.getElementById('portfolioChart'));
            //     const option = portfolioChart.getOption();
            //     const lastCashValue = option.series[4].data[option.series[4].data.length - 1];
            //     option.series[4].data[option.series[4].data.length - 1] = currentCash;
            //     option.series[0].data[option.series[0].data.length - 1] =
            //     option.series[0].data[option.series[0].data.length - 1] - lastCashValue + currentCash;
            //     portfolioChart.setOption(option);
            // }
            addAssetBtn.addEventListener('click', function() {
                modal.classList.remove('hidden');
            });
            closeModal.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            cancelBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });
    </script>
    <script id="portfolioTableControls">
        // 加载投资组合表格数据
        // 获取资产实时价格
        async function loadStockPrice(symbol) {
          try {
            const res = await fetch(`/api/stock/${symbol}`);
            const data = await res.json();
            if (data.price) {
              document.getElementById(`price-${symbol}`).textContent = `$${data.price.toFixed(2)}`;
            } else {
              document.getElementById(`price-${symbol}`).textContent = 'N/A';
            }
          } catch (e) {
            console.error(e);
            document.getElementById(`price-${symbol}`).textContent = 'Error';
          }
        };
        async function loadPortfolioTable() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();
                const tbody = document.getElementById("portfolio-body");
                tbody.innerHTML = "";

                for (const item of data) {
                    // 获取实时价格
                    const res = await fetch(`/api/stock/${item.asset_symbol}`);
                    const stockData = await res.json();
                    const currentPrice = stockData.price || item.price_per_unit;

                    // 计算涨跌幅
                    const changePercent = ((currentPrice - item.price_per_unit) / item.price_per_unit) * 100;
                    const isPositive = changePercent >= 0;

                    // 设置颜色
                    const badgeColor = isPositive ? "green" : "red";
                    const changeText = `${isPositive ? "+" : ""}${changePercent.toFixed(2)}%`;

                    // 创建表格行
                    const row = document.createElement("tr");
                    let color = "blue";
                    if (item.asset_type === "etf") {
                        color = "purple";
                    } else if (item.asset_type === "bond") {
                        color = "yellow";
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                        <div class="w-8 h-8 flex items-center justify-center bg-${color}-100 rounded-lg mr-3">
                        <i class="ri-${item.asset_type}-line text-${color}-600 text-sm"></i>
                        </div>
                        <div>
                        <div class="text-sm font-medium text-gray-900">${item.asset_name}</div>
                        <div class="text-sm text-gray-500 symbol">${item.asset_symbol}</div>
                        </div>
                        </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${item.price_per_unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" id="price-${item.asset_symbol}">$${currentPrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">$${(currentPrice * item.quantity).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${badgeColor}-100 text-${badgeColor}-800">
                        ${changeText}
                        </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button class="text-primary hover:text-primary/80 buy-btn">Buy</button>
                        <button class="text-red-600 hover:text-red-800 sell-btn">Sell</button>
                        </td>
                    `;

                    tbody.appendChild(row);
                }

            } catch(err) {
                console.error("Failed to load portfolio", err);
            }
        };

        document.addEventListener("DOMContentLoaded", async function () {
            await loadPortfolioTable(); // 先加载表格

            // 绑定时间按钮事件
            const timeButtons = document.querySelectorAll('.lg\\:col-span-2 button');
            timeButtons.forEach(button => {
            button.addEventListener('click', function () {
                timeButtons.forEach(btn => {
                btn.classList.remove('text-primary', 'bg-primary/10');
                btn.classList.add('text-gray-600');
                });
                this.classList.remove('text-gray-600');
                this.classList.add('text-primary', 'bg-primary/10');
                });
            });

            // 绑定资产类别按钮事件
            const categoryButtons = document.querySelectorAll('.category-btn');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function () {
                    categoryButtons.forEach(btn => {
                        btn.classList.remove('text-primary', 'bg-primary/10');
                        btn.classList.add('text-gray-600');
                    });
                    this.classList.remove('text-gray-600');
                    this.classList.add('text-primary', 'bg-primary/10');

                    const category = this.textContent.trim();
                    const rows = document.querySelectorAll("tbody tr"); // 每次点击时重新获取行

                    rows.forEach(row => {
                        const icon = row.querySelector(".ri-stock-line, .ri-etf-line, .ri-bond-line");
                        if (!icon) return;

                        const isStock = icon.classList.contains("ri-stock-line");
                        const isETF = icon.classList.contains("ri-etf-line");
                        const isBond = icon.classList.contains("ri-bond-line");

                        if (category === "All Assets" ||
                            (category === "Stocks" && isStock) ||
                            (category === "ETFs" && isETF) ||
                            (category === "Bonds" && isBond)) {
                            row.style.display = "";
                        } else {
                            row.style.display = "none";
                        }
                    });
                });
            });
        });
    </script>
    <script id="totalValueControls">
        async function updatePortfolioUI() {
            try {
                const res = await fetch('/api/allAsset');
                const { asset } = await res.json(); // 确保后端返回的是 { asset: { Stocks, ETFs, Bonds, Cash } }

                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                });

                // 更新资产分类的数值
                document.getElementById('stocksValue').textContent = formatter.format(asset.Stocks);
                document.getElementById('etfsValue').textContent = formatter.format(asset.ETFs);
                document.getElementById('bondsValue').textContent = formatter.format(asset.Bonds);
                document.getElementById('cashValue').textContent = formatter.format(asset.Cash);
                document.getElementById('cashValue1').textContent = formatter.format(asset.Cash);

                // 更新总资产
                const total = asset.Stocks + asset.ETFs + asset.Bonds + asset.Cash;
                document.getElementById('totalValue').textContent = formatter.format(total);
            } catch (err) {
                console.error('Failed to fetch asset data:', err);
            }
        }

        window.addEventListener('DOMContentLoaded', updatePortfolioUI);
    </script>
    <script id="buySellControls">
        function createTradeModal() {
            const modalHTML = `
                <div id="trade-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                    <h2 id="trade-title" class="text-xl font-semibold mb-4">Trade Asset</h2>
                    <label class="block mb-2">Quantity:</label>
                    <input id="trade-quantity" type="number" class="border p-2 w-full mb-3" />

                    <label class="block mb-2">Price:</label>
                    <input id="trade-price" type="number" class="border p-2 w-full mb-3" />

                    <div class="flex justify-end space-x-3">
                    <button id="cancel-trade" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                    <button id="confirm-trade" class="px-4 py-2 bg-blue-500 text-white rounded">Confirm</button>
                    </div>
                </div>
                </div>
                `;
            document.body.insertAdjacentHTML("beforeend", modalHTML);
        }

        // 页面加载完后插入弹窗
        document.addEventListener("DOMContentLoaded", () => {
            createTradeModal();
            let currentTrade = { action: "", symbol: "" };

            // 给 Buy/Sell 按钮绑定事件
            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("buy-btn") || e.target.classList.contains("sell-btn")) {
                    const isBuy = e.target.classList.contains("buy-btn");
                    currentTrade.action = isBuy ? "buy" : "sell";
                    // 获取当前行的 symbol
                    const row = e.target.closest("tr");
                    currentTrade.symbol = row.querySelector("td .symbol").textContent.trim();
                    document.getElementById("trade-title").textContent = isBuy ? "Buy Asset" : "Sell Asset";
                    document.getElementById("trade-quantity").value = "";
                    document.getElementById("trade-price").value = "";
                    document.getElementById("trade-modal").classList.remove("hidden");
                    
                }
            });

            // 绑定弹窗按钮事件
            // Cancel关闭弹窗
            document.getElementById("cancel-trade").addEventListener("click", () => {
                document.getElementById("trade-modal").classList.add("hidden");
            });
            // Confirm确认交易
            document.getElementById("confirm-trade").addEventListener("click", async () => {
                const quantity = parseInt(document.getElementById("trade-quantity").value);
                const price = parseFloat(document.getElementById("trade-price").value);

                const payload = {
                    symbol: currentTrade.symbol,
                    action: currentTrade.action,
                    quantity,
                    price
                };

                try {
                    // const res = await fetch("/api/trade", {
                    //     method: "POST",
                    //     headers: { "Content-Type": "application/json" },
                    //     body: JSON.stringify({ symbol: currentTrade.symbol, quantity, price, type: currentTrade.type })
                    // });
                    // const result = await res.json();
                    // console.log("Trade success:", result);
                    console.log("Test");
                } catch (err) {
                    console.error("Trade failed:", err);
                }
                document.getElementById("trade-modal").classList.add("hidden");
            });
        });
    </script>
    <script id="addAssetControls">
        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.getElementById("addAssetModal");
            const openBtn = document.getElementById("openAddAsset");
            const closeBtn = document.getElementById("closeModal");
            const cancelBtn = document.getElementById("cancelBtn");
            const form = modal.querySelector("form");

            // 打开弹窗
            openBtn.addEventListener("click", () => {
                modal.classList.remove("hidden");
            });

            // 关闭弹窗
            function closeModal() {
                modal.classList.add("hidden");
            }
            closeBtn.addEventListener("click", closeModal);
            cancelBtn.addEventListener("click", closeModal);

            // 提交表单
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const assetType = document.getElementById("asset-type").value;
                const assetSymbol = form.querySelector("input[placeholder='e.g., AAPL']").value.trim();
                const quantity = parseInt(form.querySelector("input[placeholder='Enter quantity']").value);
                const purchasePrice = parseFloat(form.querySelector("input[placeholder='Enter purchase price']").value);
                const purchaseDate = form.querySelector("input[type='date']").value;

                const payload = { assetType, assetSymbol, quantity, purchasePrice, purchaseDate };

                // 模拟请求后端
                console.log("模拟提交：", payload);

                closeModal();
            });
        });
    </script>
</body>
</html>